<!DOCTYPE html>
<html>

<head>

  <title>字节的原码、补码与反码</title>
  <!--Import Google Icon Font-->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <!--Import materialize.css-->
  <link type="text/css" rel="stylesheet" href="/css/materialize.css" media="screen,projection" />
  <link type="text/css" rel="stylesheet" href="/css/custom.css" media="screen,projection" />
  <!--Let browser know website is optimized for mobile-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta charset="utf-8" />
  <meta name="theme-color" content="#ee6e73" />
  <link rel="shortcut icon" href="/apqx.ico" />
</head> 

<header>
  <!-- nav-bar -->
  <div class="navbar-fixed">
    <nav>
      <!-- nav-tag -->
      <div class="nav-wrapper container">
        <a href="https://apqx.me" class="brand-logo">APQX</a>
        <a href="#" data-target="nav-mobile" class="sidenav-trigger">
          <i class="material-icons">menu</i>
        </a>
        <ul class="right hide-on-med-and-down clear">
          <li  class="active" >
            <a class="waves-effect waves-effect" href=" /index.html ">随笔</a>
          </li>
          <li >
            <a class="waves-effect waves-effect" href=" /index-share.html ">转载</a>
          </li>
          <li>
            <a class="waves-effect waves-effect modal-trigger" href="#about_me">关于我</a>
          </li>
        </ul>
      </div>
    </nav>
  </div>
  <!-- pop-up-about-me -->
  <div id="about_me" class="modal container">
    <div class="modal-content">
      <center>
        <img height="100px" width="100dx" class="circle responsive-img" src=" /assets/me.jpg " />
      </center>
      <center>
        <h4>APQX</h4>
      </center>
      <p class="flow-text center-align">野生散养攻城狮，努力晋级中</p>
      <div class="collection">
        <a href="https://github.com/apqx" class="collection-item" target="blank">GitHub</a>
        <a href="https://www.facebook.com/apqx.me" class="collection-item" target="blank">Facebook</a>
        <a href="https://weibo.com/u/3288422413" class="collection-item" target="blank">Weibo</a>
        <a href="mailto:changgongapq@gmail.com" class="collection-item" target="blank">changgongapq@gmail.com</a>
      </div>
    </div>
  </div>
  <!-- slide-to-show-nav-tag -->
  <ul id="nav-mobile" class="sidenav clear">
    <li  class="active" >
      <a class="waves-effect waves-red" href=" /index.html ">随笔</a>
    </li>
    <li >
      <a class="waves-effect waves-red" href=" /index-share.html ">转载</a>
    </li>
    <li>
      <a class="waves-effect waves-red modal-trigger" href="#about_me">关于我</a>
    </li>
  </ul>

  <!-- parallax-slid-img -->
  <!-- 索引页面不显示 -->
  
  <div class="parallax-container hide-on-med-and-down">
    <div class="parallax">
      <img src="/assets/androidStudio.png">
    </div>
  </div>
  

</header>

<body class="gray">

  
  <!-- content-card -->
  <div class="container">
    <div class="card-panel hoverable">
      <!-- content -->
   
    <p class="title">字节的原码、补码与反码</p>
    <p class="author">APQX</p>
    <p class="date">2018年08月27日</p>
    <p>近期项目中经常需要处理串口数据的解析，在将收到的字节数据进行校验、计算、转换时，遇到了一些有意思的问题，其实只要了解Java对基本数据类型的存储、计算方式，这些问题就可以很好的理解并解决。</p>

<h1 id="一个简单的示例">一个简单的示例</h1>

<p>从串口中收到了一个长度为2的字节数组，现在要以大端模式读取这2个字节表示的正数数值，</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>byte[] array = readSerialBytes();

int result = (array[0] &lt;&lt; 8) + array[1];
</code></pre></div></div>

<p>将<code class="highlighter-rouge">array[0]</code>左移8位再加上<code class="highlighter-rouge">array[1]</code>，这样计算看起来没什么问题，但总会遇到一些数据，计算值和实际值不同，比如</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>array[0] = 0x81 = 1000 0001(二进制) = 129(十进制)
array[1] = 0x81 = 1000 0001(二进制) = 129(十进制)
</code></pre></div></div>

<p>理论上计算结果应该是<code class="highlighter-rouge">0x8181</code>即<code class="highlighter-rouge">33153</code>，但按上面的计算方法，结果却是<code class="highlighter-rouge">-32639</code>，很奇怪吧，要找出出现这种情况的原因，首先需要理解关于字节的几个概念。</p>

<h1 id="机器数与真值">机器数与真值</h1>

<p>任何数据，都是以二进制位的形式进行计算和存储的，在计算机中，以最高位作为<code class="highlighter-rouge">符号位</code>，1表示负数，0表示正数，其余为<code class="highlighter-rouge">数据位</code>，这种存储方式的数据称为<code class="highlighter-rouge">机器数</code>。至于<code class="highlighter-rouge">真值</code>，就是机器数所表示的真实数值，所以真值是有符号的。</p>

<p>以1个字节为例，最高位为符号位，有7个数据位，所能表示的真值范围是-127 ~ +127。</p>

<h1 id="反码">反码</h1>

<p>机器数，正数的反码是其本身，负数的反码是除符号位外，其余位取反。</p>

<h1 id="补码">补码</h1>

<p>机器数，正数的补码是其本身，负数的补码是除符号为外，其余位取反，然后加1，即负数的反码加1。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center">机器数</th>
      <th style="text-align: center">真值</th>
      <th style="text-align: center">反码</th>
      <th style="text-align: center">补码</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0000 0001</td>
      <td style="text-align: center">1</td>
      <td style="text-align: center">0000 0001</td>
      <td style="text-align: center">0000 0001</td>
    </tr>
    <tr>
      <td style="text-align: center">1000 0001</td>
      <td style="text-align: center">-1</td>
      <td style="text-align: center">1111 1110</td>
      <td style="text-align: center">1111 1111</td>
    </tr>
  </tbody>
</table>

<h1 id="反码补码存在的意义">反码、补码存在的意义</h1>

<p>为什么一定要有反码和补码呢，这其实和计算机本身的计算特性有关，计算机的位运算实际上只能处理加法，减法是以加法的形式实现的，比如<code class="highlighter-rouge">1-1</code>，会转化为<code class="highlighter-rouge">1+(-1)</code>，这个就需要用到反码和补码了。</p>

<p>对于<code class="highlighter-rouge">1-1 = 1+(-1)</code>这样的计算，如果用原码</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1-1 = 1+(-1) = 0000 0001(原码) + 1000 0001(原码) = 1000 0010(原码) = -2(真值)
</code></pre></div></div>

<p>显然是不正确的，如果对负数使用反码</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1-1 = 1+(-1) = 0000 0001(反码) + 1111 1110(反码) = 1111 1111(反码) = -0(真值)
</code></pre></div></div>

<p>实际上，正0和负0都是0，但如果用补码，就可以消除这个潜在的歧义</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1-1 = 1+(-1) = 0000 0001(补码) + 1111 1111(补码) = 0000 0000(补码) = 0(真值)
</code></pre></div></div>

<p>结果是正确的0，这也就是反码、补码存在的意义。</p>

<h1 id="问题解析">问题解析</h1>

<p>再回到最初的那个问题，很明显，计算逻辑是正确的，但为什么没有得到正确的值呢？</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>byte[] array = readSerialBytes();

int result = (array[0] &lt;&lt; 8) + array[1];
</code></pre></div></div>

<p>问题就在于<code class="highlighter-rouge">符号位</code>，在Java中，每种基本数据类型，都具有固定的字节长度，均以最高位作为符号位，在进行计算时，必须确保<code class="highlighter-rouge">符号位</code>始终发挥正确的作用。</p>

<p>很明显对字节<code class="highlighter-rouge">array[0]</code>和<code class="highlighter-rouge">array[1]</code>来说，它们都是最终值的一部分，是不应该有<code class="highlighter-rouge">符号位</code>的，或者说它们的<code class="highlighter-rouge">符号位</code>应该作为<code class="highlighter-rouge">数据位</code>参与计算，最终结果以<code class="highlighter-rouge">int</code>值表示。</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int result = ((array[0] &amp; 0xff) &lt;&lt; 8) + (array[1] &amp; 0xff)
</code></pre></div></div>

<p>byte &amp; 0xff的作用是，将字节转换为无符号数，并扩展为<code class="highlighter-rouge">int</code>，这样再进行移位操作就能得到正确的数值了。</p>

<p>那为什么会出现<code class="highlighter-rouge">-32639</code>这个数呢，下面就是答案</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>int result = (array[0] &lt;&lt; 8) + array[1];
           = 1000 0001 0000 0000(补码) + 1111 1111 1000 0001(补码)
           = 1000 0000 1000 0001(补码)
           = -32639(真值)
</code></pre></div></div>
 
      
  
      <!-- content -->
    </div>
  </div>
  
  
  <!-- float-btn -->
  <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
    <a class="btn-floating btn-large waves-effect waves-light green" href="#">
      <i class="material-icons">arrow_upward</i>
    </a>
  </div>

  <footer class="page-footer ">
  <div class="footer-copyright">
    <div class="container">
      Based on
      <a class="orange-text text-lighten-3" target="blank" href="https://materializecss.com">Materialize</a> and 
      <a class="orange-text text-lighten-3" target="blank" href="https://jekyllrb.com/">Jekyll</a>
    </div>
  </div>
</footer>

  <!--Import jQuery before materialize.js-->
  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src=" /js/materialize.js "></script>
  <script type="text/javascript" src=" /js/init.js "></script>
  <script type="text/javascript" src=" /codeHighLight/highlight.pack.js "></script>
  <link rel="stylesheet" href=" /codeHighLight/styles/darcula.css ">
</body>

</html>