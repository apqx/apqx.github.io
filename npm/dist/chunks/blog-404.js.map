{"version":3,"file":"blog-404.js","sources":["../../src/component/react/ProgressLinear.tsx","../../src/component/dialog/ShortLinkJumpDialogViewModel.ts","../../src/component/dialog/ShortLinkJumpDialog.tsx","../../src/page/404.ts"],"sourcesContent":["import \"./ProgressLinear.scss\"\nimport React, { useEffect } from \"react\"\nimport { MDCLinearProgress } from \"@material/linear-progress\"\n\ninterface Props {\n    loading: boolean\n    classes?: string[]\n}\n\nexport function ProgressLinear(props: Props) {\n    const containerRef = React.useRef<HTMLDivElement>(null)\n    const progressLinear = React.useRef<MDCLinearProgress>(null)\n\n    useEffect(() => {\n        const ele = containerRef.current as Element\n        progressLinear.current = new MDCLinearProgress(ele)\n        return () => {\n            progressLinear.current?.destroy()\n        }\n    }, [])\n\n    useEffect(() => {\n        if (props.loading) {\n            progressLinear.current!!.determinate = false\n            progressLinear.current?.open()\n        } else {\n            progressLinear.current!!.determinate = false\n            progressLinear.current?.close()\n        }\n    }, [props.loading])\n\n\n    return (\n        <div ref={containerRef} role=\"progressbar\" className={`mdc-linear-progress ${props.classes?.join(\" \") ?? \"\"}`.trimEnd()}>\n            <div className=\"mdc-linear-progress__buffer\">\n                <div className=\"mdc-linear-progress__buffer-bar\"></div>\n                <div className=\"mdc-linear-progress__buffer-dots\"></div>\n            </div>\n            <div className=\"mdc-linear-progress__bar mdc-linear-progress__primary-bar\">\n                <span className=\"mdc-linear-progress__bar-inner\"></span>\n            </div>\n            <div className=\"mdc-linear-progress__bar mdc-linear-progress__secondary-bar\">\n                <span className=\"mdc-linear-progress__bar-inner\"></span>\n            </div>\n        </div>\n    )\n}\n","import { consoleDebug, consoleError } from \"../../util/log\"\nimport { runAfterMinimalTime } from \"../../util/tools\"\nimport type { ApiUrlMap } from \"../../repository/bean/service/ApiUrlMap\"\nimport { getServiceInstance, SERVICE_DEBUG_MODE_AUTO } from \"../../repository/Service\"\nimport { BaseExternalStore } from \"../base/paginate/BaseExternalStore\"\n\ninterface State {\n    title: string\n    content: string\n    onClickLink: () => void\n}\n\nexport class ShortLinkJumpDialogViewModel extends BaseExternalStore {\n    state: State = {\n        title: \"查询映射\",\n        content: \"\",\n        onClickLink: () => { }\n    }\n\n    constructor(pid: string) {\n        super()\n        this.state.content = pid\n    }\n\n\n    /**\n     * 从 url 映射文件中查询 pid\n     */\n    findPage(pid: string) {\n        let startTimeMs = Date.now()\n        getServiceInstance().getUrlMap({ debugMode: SERVICE_DEBUG_MODE_AUTO })\n            .then(response => {\n                if (response.status === 200) {\n                    return response.json()\n                } else {\n                    throw new Error(\"Something went wrong on api server!\")\n                }\n            })\n            .then((response: ApiUrlMap) => {\n                for (const item of response.map) {\n                    if (item.id === pid) {\n                        consoleDebug(\"Find pid \" + pid + \" => \" + item.target.path)\n                        // 跳转到目标页，不在浏览器中保留跳转记录，url 可以是站内的相对 path，也可以是站外 http 的绝对 path\n                        var jumpUrl = item.target.path\n                        if (!item.target.path.startsWith(\"http\")) {\n                            jumpUrl = window.location.origin + item.target.path\n                        }\n                        consoleDebug(\"JumpUrl is \" + jumpUrl)\n                        this.showJump(startTimeMs, jumpUrl, item.target.title)\n                        return\n                    }\n                }\n                this.showJump(startTimeMs, window.location.origin + \"/404.html\", \"未找到目标页面\")\n                consoleDebug(\"Pid not exist, check url-map\")\n            }).catch(error => {\n                consoleError(error)\n                this.showJump(startTimeMs, window.location.origin + \"/404.html\", \"解析映射表异常\")\n            }\n            )\n    }\n\n    showJump(startTimeMs: number, url: string, linkTitle: string) {\n        // “查询映射表”应至少显示 1s，“正在跳转”应至少显示 1s\n        let timeGapQueryingMs = 800\n        runAfterMinimalTime(startTimeMs, () => {\n            this.refreshHint(linkTitle, url)\n        }, timeGapQueryingMs)\n    }\n\n    private refreshHint(linkTitle: string, url: string) {\n        this.state = {\n            title: \"正在跳转\",\n            content: linkTitle,\n            onClickLink: () => {\n                // 监听点击，手动实现跳转，且不记入浏览器的跳转记录\n                window.location.replace(url)\n            }\n        }\n        this.emitChange()\n        setTimeout(() => {\n            // 延时 1s 再跳转，显示动画\n            window.location.replace(url)\n        }, 800)\n    }\n}\n","import \"./ShortLinkJumpDialog.scss\"\nimport { useEffect, useMemo, useSyncExternalStore } from \"react\"\nimport { ProgressLinear } from \"../react/ProgressLinear\"\nimport { BaseDialog, COMMON_DIALOG_WRAPPER_ID, showDialog } from \"./BaseDialog\"\nimport type { BaseDialogOpenProps } from \"./BaseDialog\"\nimport { ShortLinkJumpDialogViewModel } from \"./ShortLinkJumpDialogViewModel\"\n\ninterface ShortLinkJumpDialogProps extends BaseDialogOpenProps {\n    pid: string\n}\n\nexport function ShortLinkDialog(props: ShortLinkJumpDialogProps) {\n    const viewModel = useMemo(() => new ShortLinkJumpDialogViewModel(props.pid), [])\n\n    const state = useSyncExternalStore(viewModel.subscribe, () => viewModel.state)\n\n    useEffect(() => {\n        viewModel.findPage(props.pid)\n    }, [])\n\n    return (\n        <BaseDialog openCount={props.openCount} closeOnClickOutside={false} actions={[]}>\n            <div className=\"jump-dialog-container center-inline-items\">\n                <picture>\n                    <source srcSet=\"https://apqx-host.oss-cn-hangzhou.aliyuncs.com/blog/emojis/noto-animated-emoji/peacock/512.webp\"\n                        type=\"image/webp\" />\n                    <img className=\"inline-for-center emoji-jump\" alt=\"\"\n                        src=\"https://apqx-host.oss-cn-hangzhou.aliyuncs.com/blog/emojis/noto-animated-emoji/peacock/512.gif\" />\n                </picture>\n                <p id=\"short-link-jump-dialog_title\">{state.title}</p>\n                <p id=\"short-link-jump-dialog_link\" className=\"center-inline-items\">\n                    <a className=\"clickable-empty-link\" onClick={state.onClickLink}>{state.content}</a>\n                </p>\n                <ProgressLinear loading={true} />\n            </div>\n        </BaseDialog>\n    )\n}\n\nlet openCount = 0\nexport function showShortLinkJumpDialog(_pid: string) {\n    showDialog(<ShortLinkDialog openCount={openCount++} pid={_pid} />, COMMON_DIALOG_WRAPPER_ID)\n}\n","import \"./404.scss\"\nimport { showShortLinkJumpDialog } from \"../component/dialog/ShortLinkJumpDialog\";\nimport { consoleDebug } from \"../util/log\";\nimport { runOnHtmlDone, runOnPageDone } from \"../util/tools\";\nimport { initContentCard } from \"../component/contentCard\";\n\n\nexport function init404() {\n    runOnHtmlDone(() => {\n        // 404页面，卡片默认是隐藏的，由动画类之外的机制控制\n        // 这里像其它页面一样正常处理动画类\n        initContentCard(false)\n    })\n\n    runOnPageDone(() => {\n        checkJump()\n    })\n}\n\n/**\n * 进入页面，检查是否携带了跳转参数\n * https://mudan.me/pid\n */\nfunction checkJump() {\n    let pid = null\n    const urlPath = window.location.pathname\n    consoleDebug(\"Url path = \" + urlPath)\n    // https://mudan.me/op01\n    // https://mudan.me/opera\n    // og: original\n    // rp: repost\n    // op: opera\n    // pt: poetry\n    // ot: other\n    var matches = urlPath.match(RegExp(\"^/((og|rp|op|pt|ot)\\\\d\\\\d|index-opera|opera|lens|repost|poetry|share|print|kfc)$\"))\n    consoleDebug(\"Url matches = \" + matches)\n    if (matches != null && matches.length > 0) {\n        // 检查是否符合格式，取出pid\n        // https://mudan.me/id\n        pid = matches[1]\n    }\n    if (pid == null) {\n        // 不是短链跳转，如果处于404页，显示404提示（默认是不显示的）\n        const eCard = document.querySelector(\".content-card\")\n        if (eCard != null) {\n            (eCard as HTMLElement).style.display = \"block\"\n        }\n        return\n    }\n    // 查询url映射表中的pid\n    showShortLinkJumpDialog(pid)\n}\n"],"names":["ProgressLinear","props","containerRef","React","progressLinear","useEffect","ele","MDCLinearProgress","jsxs","jsx","ShortLinkJumpDialogViewModel","BaseExternalStore","pid","startTimeMs","getServiceInstance","SERVICE_DEBUG_MODE_AUTO","response","item","consoleDebug","jumpUrl","error","consoleError","url","linkTitle","runAfterMinimalTime","ShortLinkDialog","viewModel","useMemo","state","useSyncExternalStore","BaseDialog","openCount","showShortLinkJumpDialog","_pid","showDialog","COMMON_DIALOG_WRAPPER_ID","init404","runOnHtmlDone","initContentCard","runOnPageDone","checkJump","urlPath","matches","eCard"],"mappings":"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"}