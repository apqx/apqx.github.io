---
layout: post
categories: original
title: "新零售终端的一些实现"
author: 立泉
mention: 工作 自动售货机
date: 2019-04-22 +0800
description: 即将离开我毕业后加入的第一家公司，有些舍不得那些熟悉人和物，毕竟是待了两年的地方，都有点家的感觉了，但另一方面也像是长舒了一口气，甩掉了一个包袱，我不应该被过去束缚，有很多一直想做的事，外面有更广阔的世界。
cover: https://apqx.oss-cn-hangzhou.aliyuncs.com/blog/20190422/zongs_app_old_thumb.jpg
tags: CS Android 工作 自动售货机
---

即将离开我毕业后加入的第一家公司，有些舍不得那些熟悉人和物，毕竟是待了两年的地方，都有点家的感觉了，但另一方面也像是长舒了一口气，甩掉了一个包袱，我不应该被过去束缚，有很多一直想做的事，外面有更广阔的世界。

这两年来，我看到了一个初创企业在新零售领域所做的一些努力，不断的产品迭代，不断的组织结构调整，从背靠大树好乘凉的轻松，到被迫独立运营时的窘迫，这些真实发生的事情让我对商业的运行规则颇有兴趣，但这篇文章不谈论这些，想聊一下我接触到的新零售终端设备的一些业务实现方式。这些东西并不复杂，也远达不到什么商业的机密，不同的公司对这些业务的具体实现细节未必相同，不过架构应该是大体相似的。

# 架构演进

我看到的大部分新零售终端，或者叫自动售货机，其实结构很简单，1台`机器` + 1个`大屏` + 1台`Android工控机` + 1张`物联网卡`，稍微复杂点的，可以在工控机或机器主板上通过`串口`外接一些附加的售卖柜。其它的差异性还会表现在机器的货道设计和出货方式上，有蛇形货道的饮料机、直通式货道的饮料机、依靠弹簧转动的综合机、依靠履带传动的综合机，还有那种具有机械接货斗、可以卖一些易碎物品的综合机，后期还出现了咖啡机、啤酒机、现调饮料机等机型。但这些都属于硬件层面的，我们所关注的是上层`Android工控机`上运行的售卖程序，它通过网络连接公司服务器，通过`串口`连接下层机器硬件，处理订单信息，指令机器动作，并实时上报各种状态信息。简单的说，自动售货机就是一个大型的`Android`手机，运行的就是普通的`Android软件`，只是多了一条通过`串口`控制机器硬件的连接线。


![](https://apqx.oss-cn-hangzhou.aliyuncs.com/blog/20190422/zongs_app_old_thumb.jpg){: loading="lazy" class="clickable clickShowOriginalImg" alt="自动售货机 架构" }

我所维护的自动售卖APP经历过两个阶段，刚入职的1年左右，公司的体量还比较小，机型也只有富士饮料机、澳柯玛饮料机和澳柯玛弹簧机三种，我和另外2个同事，每人负责一种机型的更新、迭代，新零售终端依赖的售卖、补货、控制、广告等所有功能都集中在该机型的一个APP里。其实，即使在机型较少的那个阶段，这种模式已经出现了很明显的问题，我们三个人每人维护一套代码，并且因历史遗留，这三份代码结构差异非常大，从使用的类库到软件架构，都不相同。当时也没有统一模块化的意识，这意味着，当售货机要增加一个新功能时，比如接入新的广告系统，我们每个人都要在自己的代码里实现一遍。这看起来很可笑，明明可以写一个独立的广告模块，统一接口，再分别集成到三份代码里，这样广告模块就只需要实现一遍，代码的可复用性和维护性就会大为改善，也会推动所用功能的模块化进程。但事实是，直到接入的机型越来越多，以这种原始的方式无法应对时，才开始改变，走向真正的模块化尝试，也就是第二阶段。

![](https://apqx.oss-cn-hangzhou.aliyuncs.com/blog/20190422/zongs_app_new_thumb.jpg){: loading="lazy" class="clickable clickShowOriginalImg" alt="自动售货机 架构" }

我们把售货机分为两种，`基于货道`和`基于配方`。对于最常见的饮料机和综合机，不管它们的出货方式多么的奇葩，机器硬件通过`串口`向上层`Android`工控机显示的，都只是一个一个的货道，通过各个厂家不同的`串口通信协议`，可以控制每一个货道的补货和出货。对于咖啡机和现调饮料机，它们是没有货道概念的，只有不同口味的配方和原料存量，在软件设计上很明显的和基于货道的机型完全不一样。所以，我们把两种机器分开，分别为之构建一个该机种通用的售卖上层APP，展示前台售卖和后台补货UI，统一处理订单和机器信息的上报。把广告、支付、`串口`分别独立构建为广告APP、工具APP和设备APP，它们通过`Android IPC`进程间通信和通用售卖上层APP进行数据和动作的信息交换。对于同一机种的不同的机型，通用售卖上层APP是同一个，广告APP和工具APP也是相同的，只有和`串口通信协议`相关的硬件控制部分，需要因厂家的定义不同而分别单独构建每个机型的设备APP。这样的话，适配新机型，只用根据定义好的通信接口来实现具体的`串口通信协议`，完成该机型的设备APP即可，其他都无需改动。各个APP可以单独升级，由后台根据机器编号和机型来完全控制更新、维护的具体细节，我们觉得，这样的模块化，已经足以应对公司未来可能要接入的越来越多的机型了。

# 订单处理

在新的架构里，订单的处理逻辑，包括生成订单、接收订单、校验订单、实时上报订单状态，是在通用售卖上层APP里完成的。当收到的订单确认合法后，它会通过`Android IPC`机制调用设备APP的出货方法，设备APP再根据`串口通信协议`，向底层的机器硬件发出规定的出货字节指令，并把硬件报告的出货结果返回给上层售卖APP，然后再记录实际的订单出货状态，报告给服务器。

![](https://apqx.oss-cn-hangzhou.aliyuncs.com/blog/20190422/zongs_order_thumb.jpg){: loading="lazy" class="clickable clickShowOriginalImg" alt="自动售货机 订单处理" }

具体的代码逻辑实现上，我们使用的是典型的`生产者-消费者`模式。创建一个阻塞队列，所有验证合法的订单，包括本地生成的现金支付订单、通过MQ消息推送收到的服务器生成的扫码支付订单和刷脸支付订单，都会被存入到这个阻塞队列里。有一个处理订单的独立工作线程，不断的尝试从队列里获取订单，因为阻塞队列的特性，当队列里没有订单的时候，该工作线程会处于被阻塞的等待状态，有订单的时候，该线程会被唤醒并根据要出货的商品信息，确定具体的出货货道，通过`Android IPC`机制通知设备APP执行硬件出货，获取出货结果，更新订单状态，实时上报。

# 外围设备

很多人都应该见过，有的自动售货机旁边会外挂一台或多台售货柜，它们没有独立的屏幕，但可以在主售货机的屏幕上购买这些柜子里的商品，这些都是表层的业务场景，但在外接柜子这样的软件实现上，其实是有两种。

有的柜子是接在售货机的主板上的，由售货机自己和附加柜进行通信，收发一些轮询、出货指令之类的，对于向上层`Android工控机`的`串口通信协议`定义，他们使用了一种叫“箱号”或者“柜号”的概念。比如，主售货机箱号是0，第一个附加柜箱号是1，第二个附加柜箱号是2，以此类推，此时工控机依然只通过一根串口线连接主售货机，发出的出货指令除了指定货道号外，还要指定出货的机器箱号，这样主售货机就会定位到具体的柜子和货道，完成硬件上的出货动作。

有的柜子是直接接在`Android工控机`的`串口`上的，我们使用的映翰通和四信工控机都具有多个`串口`，一个`串口`接在主售货机上，其它`串口`则可以外接很多这种附加柜，根据柜子的通信协议，由售卖软件处理和柜子的那些轮询、出货指令。

很明显的是，这两种，对售卖软件的工作量定义是不同的，一种不需要售卖软件和附加柜通信，一种则需要。在软件的实现上，以兼容的原则，售卖软件需要具备和附加柜的通信能力，并且在对订单的定义上，需要扩充“箱号”这个概念，机器的类型也要扩充“箱号柜”和“串口柜”这两个概念。这些并不是在售卖软件设计之初就能考虑到的，我们先接触的都是直接和`串口`通信的附加柜，当后来出现接在主售货机主板上的附加柜时，自然而然的会修改软件内部的数据结构，来适应这种改变，所谓软件的功能迭代，就是这样一点点不断完善的，最终，才能做出一个兼容所有机型的通用售卖上层APP。

# 关于外接刷卡器

在一些特殊的场景下，会产生一些奇奇怪怪的需求，比如在学校里投放自动售货机，尤其是中小学，限制学生使用手机，而如果全使用现金购买的话，对机器内硬币器的找零维护工作量就会变得很大。所以，有些经销商就开始向技术部提出售货机外接一台学校使用的刷卡POS机，来实现学生直接用校园卡进行购买的功能。

这样的功能需求具有合理性，但真正实施起来却有一个非常现实的问题，想想看，我们印象中，是不是每一所学校的刷卡系统都不相同，他们使用的POS机也多种多样，意味着，我们只能根据经销商机器投放的学校，联系建造刷卡系统的厂家，确认他们的产品是否可以实现接收外部设备主发的扣款指令，这样一家一家的逐个对接。其实，如果运气好的话，可能几个经销商提交的开发需求是同一个刷卡器厂家，那就只需要对接一次，售货机就可以支持多个学校的刷卡购买，这样的事确实发生过，还不止一次。

![](https://apqx.oss-cn-hangzhou.aliyuncs.com/blog/20190422/zongs_card_thumb.jpg){: loading="lazy" class="clickable clickShowOriginalImg" alt="自动售货机 刷卡器" }

我们在进行刷卡开发的时候，已经开始了模块化的初步尝试，最终的实现目标肯定是售卖软件需要具备连接所有已知POS机的能力，并能根据云端配置，自动选择对应的POS机厂家解析文件，来连接该类型的POS机硬件。实现方式就是`Java`的`类加载器`，我们定义好与POS机通信的所有方法接口，然后对每一种POS机，都要构建一个独立的`Jar`包，根据厂家提供的与POS机的`串口`/网络通信协议来实现这个统一的接口，这些`Jar`包被放在云端，机器需要连接哪一种POS机，就去下载对应的`Jar`包并加载即可。

# 关于公司的一些想法

作为我离开象牙塔后加入的第一家公司，两年的时间，我看到了很多，接触了很多，也学到了很多，这些都会体现在我的成长历程中。而另一方面，我也会看到一些存在的问题，有的已经存在了很久，只是无人过问，也就一直存在了下去。

我没有学过大型团体的管理和运营方面的东西，但身为被管理的一员，还是可以谈一下我的个人理解。**除去核心的技术实力，标准化的制度与清晰的流程，在我看来是公司扩张时必须拥有并坚持的两个基本原则。**人员增多，市场变大，需求递增，而如果没有人知道如何正确的、合规的、严谨的连接市场和技术，不知道如何一步一步的把市场的需求变为实际的产品，那么可想而知，内部的沟通成本将会非常巨大，需求可能会被曲解，与外部的对接也可能在无法确定具体承办责任人的情况下，旷日持久的拖延。这些真实的发生过，我经历过好几次，每次都在想，如果有标准化的制度和流程，接到需求，从市场到技术，每个人都按流程规定的做自己该做的事，至少不会出现多方无法有效沟通的混乱局面。如果没有无意义的互相甩锅，也不会有人自己生闷气吧，工作中的心情确实会影响开发效率，这是管理层应该看到的。