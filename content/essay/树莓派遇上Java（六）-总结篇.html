<!DOCTYPE html>
<html>

<head>
    <title>树莓派遇上Java（六）-总结篇</title>
    <!--Import Google Icon Font-->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <!--Import materialize.css-->
    <link type="text/css" rel="stylesheet" href="../../css/materialize.css" media="screen,projection" />

    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="utf-8" />
    <meta name="theme-color" content="#ee6e73" />
    <link rel="shortcut icon" href="../../favicon.ico" />
</head>

<body class="gray">
    <div class="navbar-fixed">
        <nav class="navbar-fixed light-red lighten-1" role="navigation">
            <div class="nav-wrapper container">
                <a id="logo-container" href="http://apqx.me" class="brand-logo">APQX</a>
                <ul id="nav-mobile" class="side-nav">
                    <li>
                        <a class="waves-effect waves-red" href="../../content/essay/index.html">随笔</a>
                    </li>
                    <li>
                        <a class="waves-effect waves-red" href="../../content/share/index.html">转载</a>
                    </li>
                    <li>
                        <a class="waves-effect waves-red modal-trigger" href="#about_me">关于我</a>
                    </li>
                </ul>
                <a href="#" data-activates="nav-mobile" class="button-collapse">
                    <i class="material-icons">menu</i>
                </a>
            </div>
        </nav>
    </div>

    <div class="parallax-container">
        <div class="parallax">
            <img src=./assets/Screen.png>
        </div>
    </div>

    <div class="row section">
        <div class="col l2 hide-on-med-and-down">
            <div class="collection hoverable z-depth-1">
                <a href="../../content/essay/index.html" class="waves-effect waves-red collection-item active">随笔</a>
                <a href="../../content/share/index.html" class="waves-effect waves-red collection-item">转载</a>
                <a href="#about_me" class="waves-effect waves-red collection-item modal-trigger">关于我</a>
            </div>
        </div>
        <div class="col l2 hide-on-med-and-down">
            <pre></pre>
        </div>
        <div class="col s12 m12 l6">
            <div class="card-panel hoverable">
                <div class="container">
                    <!-- Modal Structure -->
                    <div id="about_me" class="modal">
                        <div class="modal-content">
                            <center>
                                <img height="100px" width="100dx" class="circle responsive-img" src="../../assets/me.jpg" />
                            </center>
                            <center>
                                <h4>APQX</h4>
                            </center>
                            <p class="flow-text center-align">野生散养攻城狮，努力晋级中。</p>
                            <div class="collection">
                                <a href="https://github.com/apqx" target="_blank" class="collection-item">GitHub</a>
                                <a href="https://www.facebook.com/apqx.me" target="_blank" class="collection-item">Facebook</a>
                                <a href="mailto:changgongapq@gmail.com" class="collection-item">changgongapq@gmail.com</a>
                            </div>
                        </div>
                    </div>
                    <!-- content -->
                    <h4 align="center">树莓派遇上Java（六）-总结篇</h4>
                    <p class="center flow-text">APQX</p>
                    <p class="center">2016年9月16日</p>
                    <p class="flow-text">我在前面已经写了5篇文章来介绍树莓派的基本特性和对马达、舵机、摄像头的控制方法。</p>
                    <p class="flow-text">
                        <a href="./%E6%A0%91%E8%8E%93%E6%B4%BE%E9%81%87%E4%B8%8AJava%EF%BC%88%E4%B8%80%EF%BC%89-%E6%80%BB%E8%BF%B0%E7%AF%87.html"
                            target="_blank">树莓派遇上Java(一)-总述篇</a>
                        <br/>
                        <a href="./%E6%A0%91%E8%8E%93%E6%B4%BE%E9%81%87%E4%B8%8AJava%EF%BC%88%E4%BA%8C%EF%BC%89-%E5%87%86%E5%A4%87%E7%AF%87.html"
                            target="_blank">树莓派遇上Java(二)-准备篇</a>
                        <br/>
                        <a href="./%E6%A0%91%E8%8E%93%E6%B4%BE%E9%81%87%E4%B8%8AJava%EF%BC%88%E4%B8%89%EF%BC%89-%E9%A9%AC%E8%BE%BE%E7%AF%87.html"
                            target="_blank">树莓派遇上Java(三)-马达篇</a>
                        <br/>
                        <a href="./%E6%A0%91%E8%8E%93%E6%B4%BE%E9%81%87%E4%B8%8AJava%EF%BC%88%E5%9B%9B%EF%BC%89-%E8%88%B5%E6%9C%BA%E7%AF%87.html"
                            target="_blank">树莓派遇上Java(四)-舵机篇</a>
                        <br/>
                        <a href="./%E6%A0%91%E8%8E%93%E6%B4%BE%E9%81%87%E4%B8%8AJava%EF%BC%88%E4%BA%94%EF%BC%89-%E6%91%84%E5%83%8F%E5%A4%B4%E7%AF%87.html"
                            target="_blank">树莓派遇上Java(五)-摄像头篇</a>
                    </p>
                    <p class="flow-text">当然，这些内容只是让树莓派具有了基本的硬件控制能力，我所做的Android远程控制的树莓派机器人就是以这些基本能力为基础，配合网络连接和数据传输，实现最终的预期功能，现阶段的成果如视频所示：</p>
                    <div class="video-container">
                        <embed height="415" width="544" quality="high" allowfullscreen="true" type="application/x-shockwave-flash" src="//static.hdslb.com/miniloader.swf"
                            flashvars="aid=7220639&page=1" pluginspage="//www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash"
                        />
                    </div>
                    <div class="video-container">
                        <embed height="415" width="544" quality="high" allowfullscreen="true" type="application/x-shockwave-flash" src="//static.hdslb.com/miniloader.swf"
                            flashvars="aid=7220639&page=2" pluginspage="//www.adobe.com/shockwave/download/download.cgi?P1_Prod_Version=ShockwaveFlash"
                        />
                    </div>
                    <p class="flow-text">这是最终的机器人和Android控制端软件：</p>
                    <div class="row">
                        <div class="col s12 m8">
                            <center>
                                <img class="materialboxed responsive-img" src="./assets/RaspberryPiRobot1.jpg">
                            </center>
                        </div>
                        <div class="col s12 m4">
                            <center>
                                <img class="materialboxed responsive-img" src="./assets/raspberryPiController.png">
                            </center>
                        </div>
                    </div>
                    <p class="flow-text">作为参考，我简单介绍下我的实现思路。</p>
                    <p class="flow-text">
                        <li>建立连接</li>
                        <p class="flow-text">树莓派和Android手机通过WiFi建立网络连接，首先，树莓派开机的时候自动建立一个WiFi热点，设置自身固定IP为192.168.0.1或其它，服务端软件监听任一可用端口，比如1335。Android手机连接这个WiFi热点，同时控制端软件访问树莓派IP的1335端口，即可建立Java层的Socket连接，然后可以通过流来传输数据。</p>
                        <li>通信规则</li>
                        <p class="flow-text">这个似乎没有必要提，毕竟，如果客户端和服务端都无法理解对方发送的指令，那就没有必要再做下去了。</p>
                        <li>实时判断连接状态</li>
                        <p class="flow-text">Java的Socket连接有一个很大的缺陷，即当连接意外断开的时候不会收到任何通知，这样会带来一些安全性问题，比如当命令机器人前进的过程中，机器人脱离了最大控制距离，它和控制端的连接已经断开，但是它既无法接收到控制端的停止指令，也无法意识到连接已经断开，只会执行接到的最后一条命令“前进”。要避免这种情况就需要实时判断连接状态，可以使用定时发送心跳包的方式，每5秒发送一次，每次进行三次握手，当一段时间内没有收到心跳包就可以判断连接已经断开，应该执行一些“停止”、“重连”类的指令。</p>
                        <li>功能抽象封装</li>
                        <p class="flow-text">即从最底层的发送字符串开始，对功能层层封装，对外提供清晰可靠的接口，简化上层的程序设计。比如要实现机器人的”左转“方法turnLeft()，从底层开始，首先封装左履带的前进和后退方法leftUp(),leftDown()，右履带的前进和后退方法rightUp(),rigtDown()，这样turnLeft()方法实际上只需要调用leftDown()和rightUp()方法即可实现，而不必关系更底层的履带转动是如何实现的。这被称为”黑箱“思想，上层看到的永远只是接口，而不需要关心具体的实现细节。</p>
                        <li>图片传输</li>
                        <p class="flow-text">当机器人通过摄像头拍摄了照片后，我希望立即将此图片传输到Android手机上，为了使传输的同时也可以正常地收发指令，应该单独开一个线程并建立一个新的Socket连接来传输图片，传输完成后，关闭此连接。</p>
                        <li>视频传输</li>
                        <p class="flow-text">前面提到，视频使用MJPG-Streamer来发送，Android控制端只需要使用WebView来访问指定的端口即可接收到视频流。控制摄像头云台的转向就可以控制拍摄的视频角度，我扩展了WebView的功能，监听它的点击事件，当手指在WebView上滑动的时候，软件根据滑动的方向控制摄像头云台向指定的方向转动，这种体验还是相当不错的。</p>
                        <li>体感控制</li>
                        <p class="flow-text">这个其实就是调用Android的加速度传感器，判断手机的姿态，进而控制机器人的动作，比如手机前倾，机器人就前进，手机左倾，机器人就左转，挺好玩的。</p>
                        <!-- content -->
                </div>
            </div>
        </div>
    </div>
    <!-- foot -->
    <div class="fixed-action-btn" style="bottom: 45px; right: 24px;">
        <a class="btn-floating btn-large waves-effect waves-light green" href="#">
            <i class="material-icons">publish</i>
        </a>
    </div>
    <footer class="page-footer ">
        <div class="container">
            <div class="row">
                <div class="col l3 s12">
                    <h5 class="white-text">联系我</h5>
                    <ul>
                        <li>
                            <a class="white-text" href="mailto:changgongapq@gmail.com">changgongapq@gmail.com</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="footer-copyright">
            <div class="container">
                Based on
                <a class="orange-text text-lighten-3" href="http://materializecss.com" target="_blank">Materialize</a>
            </div>
        </div>
    </footer>
    <!--Import jQuery before materialize.js-->
    <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script type="text/javascript" src="../../js/materialize.js"></script>
    <script src="../../js/init.js"></script>
    <!--Code highlight-->
    <link rel="stylesheet" href="../../codeHighLight/styles/darcula.css">
    <script src="../../codeHighLight/highlight.pack.js"></script>
    <script>
        hljs.initHighlightingOnLoad();
    </script>
</body>

</html>